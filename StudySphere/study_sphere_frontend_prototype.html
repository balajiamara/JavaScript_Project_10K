<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>StudySphere — Frontend Prototype (Fixed)</title>
  <link rel="stylesheet" href="style.css">
  <!-- <style>
    /* Basic reset & layout */
    :root{--bg:#0f1724;--card:#0b1220;--muted:#94a3b8;--accent:#7c3aed;--glass:rgba(255,255,255,0.03)}
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;margin:0;background:linear-gradient(180deg,#071023 0%, #071a2b 100%);color:#e6eef8;min-height:100vh}
    header{display:flex;align-items:center;justify-content:space-between;padding:20px 28px;border-bottom:1px solid rgba(255,255,255,0.03)}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:44px;height:44px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#06b6d4);display:flex;align-items:center;justify-content:center;font-weight:700}
    main{padding:28px;max-width:1100px;margin:20px auto}
    .card{background:var(--card);padding:18px;border-radius:12px;box-shadow:0 6px 20px rgba(2,6,23,0.6);}

    /* Landing */
    .hero{display:grid;grid-template-columns:1fr 420px;gap:28px;align-items:center}
    h1{font-size:28px;margin:0 0 6px}
    p.lead{color:var(--muted);margin-top:6px}
    .cta{display:flex;gap:10px;margin-top:14px}
    button{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:8px;color:inherit;cursor:pointer}
    button.primary{background:linear-gradient(90deg,var(--accent),#06b6d4);border:none;color:#001}

    /* Auth */
    .auth{max-width:420px;margin:0 auto}
    .field{display:flex;flex-direction:column;margin-bottom:10px}
    input,textarea,select{background:var(--glass);border:1px solid rgba(255,255,255,0.03);padding:10px;border-radius:8px;color:inherit}

    /* layout columns */
    .cols{display:grid;grid-template-columns:260px 1fr;gap:18px}
    nav.side{position:relative}
    .nav-list{display:flex;flex-direction:column;gap:8px}
    .nav-item{padding:12px;border-radius:8px;cursor:pointer}
    .nav-item.active{background:linear-gradient(90deg,rgba(124,58,237,0.16),rgba(6,182,212,0.06))}

    .groups-list{display:grid;gap:10px}
    .group-card{padding:12px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent)}
    .small{font-size:13px;color:var(--muted)}

    /* chat */
    .chat{display:flex;flex-direction:column;height:360px}
    .messages{flex:1;overflow:auto;padding:10px;display:flex;flex-direction:column;gap:8px}
    .msg{max-width:70%;padding:10px;border-radius:10px}
    .me{align-self:flex-end;background:linear-gradient(90deg,var(--accent),#06b6d4);color:#001}
    .them{align-self:flex-start;background:rgba(255,255,255,0.03)}

    /* responsive */
    @media (max-width:900px){.hero{grid-template-columns:1fr}}    
  </style> -->
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo">SS</div>
      <div>
        <div style="font-weight:700">StudySphere</div>
        <div style="font-size:12px;color:var(--muted)">Collaborative learning — frontend prototype</div>
      </div>
    </div>
    <div>
      <span id="header-user" class="small" style="margin-right:12px"></span>
      <button id="btn-logout" style="display:none">Log out</button>
    </div>
  </header>

  <main>
    <!-- LANDING -->
    <section id="page-landing" class="card" aria-hidden="false">
      <div class="hero">
        <div>
          <h1>Study together. Learn faster.</h1>
          <p class="lead">Form study groups, share notes, and discuss ideas — this is a frontend-only prototype using local storage and IndexedDB for local persistence.</p>
          <div class="cta">
            <button id="open-signup" class="primary">Get Started</button>
            <button id="open-login">Log in</button>
          </div>
          <hr style="margin:18px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)"/>
          <h3 style="margin:0 0 6px">Quick demo actions</h3>
          <ul style="color:var(--muted);margin:6px 0 0;">
            <li>Create groups locally</li>
            <li>Upload notes (stored in your browser via IndexedDB)</li>
            <li>Chat in groups (local only)</li>
          </ul>
        </div>
        <div>
          <div class="card auth">
            <h3 style="margin-top:0">Try it now</h3>
            <div style="display:flex;gap:8px">
              <button id="quick-signup" class="primary" style="flex:1">Quick Signup</button>
              <button id="demo-reset" style="flex:1">Reset Demo</button>
            </div>
            <div style="margin-top:12px;color:var(--muted);font-size:13px">Quick Signup creates a demo user and opens your dashboard. Reset clears local data from this app domain.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- AUTH PAGES -->
    <section id="page-auth" class="card" style="display:none">
      <div class="auth">
        <h3 id="auth-title">Sign up</h3>
        <div class="field"><label>Name</label><input id="auth-name" placeholder="Your name"></div>
        <div class="field"><label>Email</label><input id="auth-email" placeholder="you@example.com"></div>
        <div class="field"><label>Password</label><input id="auth-password" type="password" placeholder="password"></div>
        <div style="display:flex;gap:8px"><button id="auth-submit" class="primary">Continue</button><button id="auth-cancel">Cancel</button></div>
        <div style="margin-top:10px;color:var(--muted);font-size:13px">This demo stores user info locally in <code>localStorage</code>. Do not store real passwords here.</div>
      </div>
    </section>

    <!-- DASHBOARD -->
    <section id="page-dashboard" style="display:none">
      <div class="cols">
        <nav class="side">
          <div class="card" style="padding:14px;margin-bottom:12px">
            <div style="font-weight:700" id="dash-welcome">Welcome</div>
            <div class="small" id="dash-email"></div>
          </div>

          <div class="card nav-list">
            <div class="nav-item active" data-section="my-groups">My Groups</div>
            <div class="nav-item" data-section="discover">Discover Groups</div>
            <div class="nav-item" data-section="create">Create Group</div>
            <div class="nav-item" data-section="notes">My Notes</div>
          </div>
        </nav>

        <div>
          <div id="section-my-groups" class="card" style="margin-bottom:12px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <h3 style="margin:0">My Groups</h3>
              <div class="small">Groups you have joined or created</div>
            </div>
            <div id="groups-container" class="groups-list"></div>
            <div id="no-groups" class="small" style="margin-top:10px;color:var(--muted);display:none">You have no groups yet — create or join one.</div>
          </div>

          <div id="section-discover" class="card" style="display:none;margin-bottom:12px">
            <h3 style="margin:0 0 8px">Discover Public Groups</h3>
            <div id="discover-list" class="groups-list"></div>
            <div id="discover-login-note" class="small" style="margin-top:8px;color:var(--muted);display:none">Log in to join public groups.</div>
          </div>

          <div id="section-create" class="card" style="display:none;margin-bottom:12px">
            <h3>Create a group</h3>
            <div class="field"><label>Group name</label><input id="grp-name" placeholder="Calculus study group"></div>
            <div class="field"><label>Subject</label><input id="grp-subject" placeholder="Mathematics"></div>
            <div class="field"><label>Description</label><textarea id="grp-desc" rows="3" placeholder="What will you discuss?"></textarea></div>
            <div style="display:flex;gap:8px"><button id="create-group" class="primary">Create</button><button id="create-cancel">Cancel</button></div>
          </div>

          <div id="section-notes" class="card" style="display:none">
            <h3>My Notes (local)</h3>
            <div class="field"><label>Choose group</label><select id="notes-group"></select></div>
            <div class="field"><label>Title</label><input id="note-title"></div>
            <div class="field"><label>Choose file</label><input id="note-file" type="file"></div>
            <div style="display:flex;gap:10px"><button id="upload-note" class="primary">Upload (local)</button><button id="notes-refresh">Refresh</button></div>
            <div id="notes-list" style="margin-top:12px"></div>
          </div>

        </div>
      </div>
    </section>

    <!-- GROUP PAGE -->
    <section id="page-group" class="card" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <div>
          <div id="group-title" style="font-weight:700">Group</div>
          <div id="group-sub" class="small"></div>
        </div>
        <div>
          <button id="back-dashboard">Back</button>
          <button id="leave-group" style="margin-left:8px">Leave</button>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 360px;gap:14px">
        <div>
          <div class="card" style="margin-bottom:12px">
            <h4 style="margin:0 0 6px">Notes</h4>
            <div id="group-notes" class="small"></div>
          </div>

          <div class="card">
            <h4 style="margin:0 0 6px">Discussion</h4>
            <div class="chat">
              <div id="messages" class="messages"></div>
              <div style="display:flex;gap:8px;margin-top:8px">
                <input id="chat-input" placeholder="Write a message..." style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:var(--glass)">
                <button id="send-chat" class="primary">Send</button>
              </div>
            </div>
          </div>
        </div>

        <aside>
          <div class="card" style="margin-bottom:12px">
            <h4 style="margin:0 0 6px">Members</h4>
            <div id="group-members" class="small"></div>
          </div>

          <div class="card">
            <h4 style="margin:0 0 6px">Group Info</h4>
            <div class="small" id="group-desc"></div>
            <div style="margin-top:10px"><strong>Code:</strong> <span id="group-code"></span></div>
          </div>
        </aside>
      </div>
    </section>

  </main>

  <!-- <script>
  // =====================
  // Simple IndexedDB wrapper
  // =====================
  const DB_NAME = 'studysphere-demo';
  const DB_VERSION = 1;
  let db;
  function openDB(){
    return new Promise((res, rej) => {
      const req = indexedDB.open(DB_NAME, DB_VERSION);
      req.onupgradeneeded = e => {
        const idb = e.target.result;
        if(!idb.objectStoreNames.contains('groups')) idb.createObjectStore('groups', {keyPath:'id'});
        if(!idb.objectStoreNames.contains('notes')) idb.createObjectStore('notes', {keyPath:'id'});
        if(!idb.objectStoreNames.contains('messages')) idb.createObjectStore('messages', {keyPath:'id'});
      }
      req.onsuccess = e => { db = e.target.result; res(db); }
      req.onerror = e => rej(e.target.error);
    });
  }
  function put(store, val){
    return new Promise((res, rej) => {
      const tx = db.transaction(store, 'readwrite');
      const os = tx.objectStore(store);
      const r = os.put(val);
      r.onsuccess = () => res(r.result);
      r.onerror = e => rej(e.target.error);
    });
  }
  function getAll(store){
    return new Promise((res, rej) => {
      const tx = db.transaction(store,'readonly');
      const os = tx.objectStore(store);
      const r = os.getAll();
      r.onsuccess = () => res(r.result);
      r.onerror = e => rej(e.target.error);
    });
  }
  function getByKey(store, key){
    return new Promise((res, rej) => {
      const tx = db.transaction(store,'readonly');
      const os = tx.objectStore(store);
      const r = os.get(key);
      r.onsuccess = () => res(r.result);
      r.onerror = e => rej(e.target.error);
    });
  }
  function deleteKey(store, key){
    return new Promise((res, rej) => {
      const tx = db.transaction(store,'readwrite');
      const os = tx.objectStore(store);
      const r = os.delete(key);
      r.onsuccess = () => res();
      r.onerror = e => rej(e.target.error);
    });
  }

  // =====================
  // Helpers
  // =====================
  function uid(len=8){return Math.random().toString(36).slice(2,2+len).toUpperCase();}
  function el(selector){return document.querySelector(selector)}
  function showPage(id){document.querySelectorAll('main section').forEach(s=>s.style.display='none'); const node = el(id); if(node) node.style.display='block'}

  // =====================
  // Auth (localStorage)
  // =====================
  function currentUser(){try{return JSON.parse(localStorage.getItem('study_user') || 'null');}catch(e){return null}}
  function setUser(u){localStorage.setItem('study_user', JSON.stringify(u));}
  function logout(){localStorage.removeItem('study_user'); renderHeader(); showPage('#page-landing');}

  // =====================
  // Boot
  // =====================
  (async function init(){
    await openDB();
    attachUI();
    renderHeader();
    // If logged in, open dashboard
    if(currentUser()){
      openDashboard();
    } else {
      showPage('#page-landing');
    }
    seedDiscover();
  })();

  // =====================
  // UI wiring
  // =====================
  function attachUI(){
    // Landing
    const openSignupBtn = el('#open-signup'); if(openSignupBtn) openSignupBtn.addEventListener('click', ()=>openAuth('signup'));
    const openLoginBtn = el('#open-login'); if(openLoginBtn) openLoginBtn.addEventListener('click', ()=>openAuth('login'));
    const quickSignupBtn = el('#quick-signup'); if(quickSignupBtn) quickSignupBtn.addEventListener('click', quickSignup);
    const demoResetBtn = el('#demo-reset'); if(demoResetBtn) demoResetBtn.addEventListener('click', resetDemo);

    // Auth
    const authCancel = el('#auth-cancel'); if(authCancel) authCancel.addEventListener('click', ()=>{showPage('#page-landing')});
    const authSubmit = el('#auth-submit'); if(authSubmit) authSubmit.addEventListener('click', submitAuth);

    // Header
    const btnLogout = el('#btn-logout'); if(btnLogout) btnLogout.addEventListener('click', ()=>{logout();});

    // Dashboard nav
    document.querySelectorAll('.nav-item').forEach(it=>it.addEventListener('click', e=>{
      document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
      e.currentTarget.classList.add('active');
      const section = e.currentTarget.dataset.section;
      document.querySelectorAll('[id^="section-"]').forEach(s=>s.style.display='none');
      const target = el('#section-'+section);
      if(target) target.style.display='block';
    }));

    // Create group
    const createBtn = el('#create-group'); if(createBtn) createBtn.addEventListener('click', createGroup);
    const createCancel = el('#create-cancel'); if(createCancel) createCancel.addEventListener('click', ()=>{document.querySelectorAll('.nav-item')[0].click();});

    // Notes
    const uploadBtn = el('#upload-note'); if(uploadBtn) uploadBtn.addEventListener('click', uploadNote);
    const notesRefresh = el('#notes-refresh'); if(notesRefresh) notesRefresh.addEventListener('click', populateNotesGroups);

    // Group page
    const backBtn = el('#back-dashboard'); if(backBtn) backBtn.addEventListener('click', ()=>openDashboard());
    const sendChat = el('#send-chat'); if(sendChat) sendChat.addEventListener('click', sendMessageFromInput);
    const chatInput = el('#chat-input'); if(chatInput) chatInput.addEventListener('keypress', e=>{ if(e.key==='Enter') sendMessageFromInput(); });
  }

  // =====================
  // Auth functions
  // =====================
  function openAuth(mode){
    const titleNode = el('#auth-title'); if(titleNode) titleNode.textContent = mode==='signup' ? 'Sign up' : 'Log in';
    const landing = el('#page-landing'); if(landing) landing.style.display='none';
    const auth = el('#page-auth'); if(auth) auth.style.display='block';
  }
  function submitAuth(){
    const nameInput = el('#auth-name'); const emailInput = el('#auth-email'); const passInput = el('#auth-password');
    const name = nameInput ? nameInput.value.trim() : '';
    const email = emailInput ? emailInput.value.trim() : '';
    const pass = passInput ? passInput.value : '';
    if(!email || !pass){alert('Provide email and password');return}
    // Very simple local users store
    let users = JSON.parse(localStorage.getItem('study_users') || '[]');
    const exists = users.find(u=>u.email===email);
    const titleNode = el('#auth-title');
    if(titleNode && titleNode.textContent==='Sign up'){
      if(exists){alert('Account exists — log in instead');return}
      const u = {id:uid(6),name: name || email.split('@')[0], email, password: pass};
      users.push(u); localStorage.setItem('study_users', JSON.stringify(users));
      setUser({id:u.id,name:u.name,email:u.email});
      openDashboard();
    } else {
      if(!exists || exists.password !== pass){alert('Invalid credentials');return}
      setUser({id:exists.id,name:exists.name,email:exists.email});
      openDashboard();
    }
  }
  function quickSignup(){
    const demo = {id:uid(6),name:'Demo User',email:'demo@local'};
    // add to users store
    let users = JSON.parse(localStorage.getItem('study_users') || '[]');
    users = users.filter(u=>u.email!=='demo@local'); users.push({...demo,password:'demo'}); localStorage.setItem('study_users', JSON.stringify(users));
    setUser(demo); openDashboard();
  }
  function resetDemo(){
    if(!confirm('Clear all demo data stored in your browser for StudySphere?')) return;
    indexedDB.deleteDatabase(DB_NAME);
    localStorage.removeItem('study_user');
    localStorage.removeItem('study_users');
    setTimeout(()=>location.reload(),250);
  }

  // =====================
  // Header & dashboard
  // =====================
  function renderHeader(){
    const u = currentUser();
    if(u){ el('#header-user').textContent = u.name + ' • ' + u.email; const b = el('#btn-logout'); if(b) b.style.display='inline-block'; } 
    else { const hu = el('#header-user'); if(hu) hu.textContent=''; const b = el('#btn-logout'); if(b) b.style.display='none'; }
  }
  async function openDashboard(){
    renderHeader();
    showPage('#page-dashboard');
    const u = currentUser();
    el('#dash-welcome').textContent = `Welcome, ${u ? u.name : 'Guest'}`;
    el('#dash-email').textContent = u ? u.email : '';
    // default nav
    const navs = document.querySelectorAll('.nav-item'); if(navs.length>0) navs[0].click();
    await refreshGroupsList();
    populateNotesGroups();
  }

  // =====================
  // Groups
  // =====================
  async function createGroup(){
    const u = currentUser(); if(!u){alert('You must be logged in to create a group. Use Quick Signup or Sign up.'); return}
    const name = el('#grp-name').value.trim();
    const subject = el('#grp-subject').value.trim();
    const desc = el('#grp-desc').value.trim();
    if(!name) {alert('Provide group name');return}
    const group = {id:uid(7),name,subject,description:desc,members:[u.id],public:true,code:uid(5)};
    await put('groups', group);
    el('#grp-name').value=''; el('#grp-subject').value=''; el('#grp-desc').value='';
    await refreshGroupsList();
    document.querySelectorAll('.nav-item')[0].click();
    alert('Group created (local) — open it from My Groups to interact');
  }

  async function refreshGroupsList(){
    const all = await getAll('groups');
    const user = currentUser();
    const container = el('#groups-container'); if(container) container.innerHTML='';
    let my = [];
    if(user){ my = all.filter(g=>g.members && g.members.includes(user.id)); }
    if(my.length===0){ const ng = el('#no-groups'); if(ng) ng.style.display='block'; } else { const ng = el('#no-groups'); if(ng) ng.style.display='none'; }
    my.forEach(g=>{
      const div = document.createElement('div'); div.className='group-card';
      div.innerHTML = `<div style=\"display:flex;justify-content:space-between;align-items:center\"><div><strong>${g.name}</strong><div class=\"small\">${g.subject} • ${g.members.length} members</div></div><div><button data-gid=\"${g.id}\">Open</button></div></div>`;
      div.querySelector('button').addEventListener('click', ()=>openGroup(g.id));
      container.appendChild(div);
    });

    // Discover list (public groups not joined)
    const discover = el('#discover-list'); if(discover) discover.innerHTML='';
    const discoverLoginNote = el('#discover-login-note'); if(discoverLoginNote) discoverLoginNote.style.display = user ? 'none' : 'block';
    const others = user ? all.filter(g=>!(g.members || []).includes(user.id)) : all;
    others.forEach(g=>{
      const d = document.createElement('div'); d.className='group-card';
      if(user){
        d.innerHTML = `<div style=\"display:flex;justify-content:space-between;align-items:center\"><div><strong>${g.name}</strong><div class=\"small\">${g.subject} • ${g.members.length} members</div></div><div><button data-join=\"${g.id}\">Join</button></div></div>`;
        d.querySelector('button').addEventListener('click', async ()=>{ g.members = g.members || []; if(!g.members.includes(user.id)){ g.members.push(user.id); await put('groups',g); await refreshGroupsList(); alert('Joined (local)'); } });
      } else {
        d.innerHTML = `<div style=\"display:flex;justify-content:space-between;align-items:center\"><div><strong>${g.name}</strong><div class=\"small\">${g.subject} • ${g.members.length} members</div></div><div class=\"small\">(Log in to join)</div></div>`;
      }
      discover.appendChild(d);
    });
  }

  async function openGroup(gid){
    const g = await getByKey('groups', gid);
    if(!g) {alert('Group not found');return}
    // render group page
    el('#group-title').textContent = g.name;
    el('#group-sub').textContent = `${g.subject} • ${(g.members||[]).length} members`;
    el('#group-desc').textContent = g.description || '—';
    el('#group-code').textContent = g.code || '—';
    const dashboard = el('#page-dashboard'); if(dashboard) dashboard.style.display='none';
    showPage('#page-group');
    // members
    const membersNode = el('#group-members'); if(membersNode) membersNode.innerHTML = '';
    const users = JSON.parse(localStorage.getItem('study_users') || '[]');
    (g.members || []).forEach(mid => {
      const uu = users.find(u=>u.id===mid);
      const name = uu ? uu.name : mid;
      const div = document.createElement('div'); div.textContent = name; if(membersNode) membersNode.appendChild(div);
    });
    // notes
    const notes = (await getAll('notes')).filter(n=>n.groupId===gid);
    renderNotesList(notes, el('#group-notes'));
    // messages
    renderMessagesForGroup(gid);
    // attach leave
    const leaveBtn = el('#leave-group');
    if(leaveBtn){
      leaveBtn.onclick = async ()=>{
        const u = currentUser(); if(!u){alert('You must be logged in to leave a group.'); return}
        if(!confirm('Leave this group?')) return;
        g.members = (g.members || []).filter(x=>x!==u.id); await put('groups',g); openDashboard();
      }
    }
  }

  // =====================
  // Notes
  // =====================
  function populateNotesGroups(){
    getAll('groups').then(all=>{
      const sel = el('#notes-group'); if(!sel) return; sel.innerHTML='';
      all.forEach(g=>{
        const opt = document.createElement('option'); opt.value = g.id; opt.textContent = g.name; sel.appendChild(opt);
      });
    });
  }

  async function uploadNote(){
    const u = currentUser(); if(!u){alert('You must be logged in to upload notes.'); return}
    const gidNode = el('#notes-group'); const gid = gidNode ? gidNode.value : null; if(!gid){alert('Choose a group');return}
    const titleNode = el('#note-title'); const title = titleNode ? titleNode.value.trim() : 'Untitled';
    const fileInput = el('#note-file'); if(!fileInput || fileInput.files.length===0){alert('Choose a file');return}
    const file = fileInput.files[0];
    const reader = new FileReader();
    reader.onload = async (e)=>{
      const blob = new Blob([e.target.result], {type:file.type});
      const note = {id:uid(9),groupId:gid,title,filename:file.name,uploadedBy:u.id,createdAt:Date.now(),fileBlob:blob};
      await put('notes', note);
      fileInput.value=''; if(titleNode) titleNode.value='';
      alert('Note saved locally in IndexedDB');
    };
    reader.readAsArrayBuffer(file);
  }

  function renderNotesList(notes, container){
    if(!container) return;
    container.innerHTML='';
    if(!notes || notes.length===0) {container.textContent='No notes yet'; return}
    notes.forEach(n=>{
      const d = document.createElement('div'); d.style.marginBottom='8px';
      const date = new Date(n.createdAt).toLocaleString();
      d.innerHTML = `<div style=\"display:flex;justify-content:space-between;align-items:center\"><div><strong>${n.title}</strong><div class=\"small\">${n.filename} • ${date}</div></div><div><button data-download=\"${n.id}\">Download</button></div></div>`;
      d.querySelector('button').addEventListener('click', async ()=>{
        // re-open note from db and download
        const rec = await getByKey('notes', n.id);
        if(rec && rec.fileBlob){
          const url = URL.createObjectURL(rec.fileBlob);
          const a = document.createElement('a'); a.href = url; a.download = rec.filename; a.click(); URL.revokeObjectURL(url);
        } else alert('File not found (this would normally be on server)');
      });
      container.appendChild(d);
    });
  }

  // =====================
  // Messages (local only)
  // =====================
  async function sendMessageFromInput(){
    const u = currentUser(); if(!u){alert('You must be logged in to send messages.'); return}
    const chatInput = el('#chat-input'); const text = chatInput ? chatInput.value.trim() : '';
    if(!text) return;
    const gid = (await currentOpenGroupId()); if(!gid) return;
    const msg = {id:uid(10),groupId:gid,from:u.id,text,ts:Date.now()};
    await put('messages', msg);
    if(chatInput) chatInput.value='';
    renderMessagesForGroup(gid);
  }
  async function renderMessagesForGroup(groupId){
    const all = await getAll('messages');
    const msgs = (all || []).filter(m=>m.groupId===groupId).sort((a,b)=>a.ts-b.ts);
    const container = el('#messages'); if(!container) return; container.innerHTML='';
    msgs.forEach(m=>{
      const div = document.createElement('div'); div.className='msg '+(m.from=== (currentUser() && currentUser().id) ? 'me':'them');
      const users = JSON.parse(localStorage.getItem('study_users')||'[]');
      const name = (users.find(u=>u.id===m.from) || {name:m.from}).name;
      div.innerHTML = `<div style=\"font-weight:600;font-size:13px\">${name}</div><div style=\"margin-top:6px;white-space:pre-wrap\">${m.text}</div><div class=\"small\" style=\"margin-top:6px;text-align:right\">${new Date(m.ts).toLocaleTimeString()}</div>`;
      container.appendChild(div);
    });
    container.scrollTop = container.scrollHeight;
  }

  async function currentOpenGroupId(){
    const titleNode = el('#group-title'); const title = titleNode ? titleNode.textContent : '';
    const all = await getAll('groups');
    const g = (all || []).find(x=>x.name===title);
    return g? g.id : null;
  }

  // =====================
  // Seed some discover groups for demo
  // =====================
  async function seedDiscover(){
    const all = await getAll('groups');
    if(all && all.length>0) return; // already seeded
    const sample = [
      {id:uid(7),name:'Calculus Study Group',subject:'Mathematics',description:'Weekly calculus exercises',members:[],public:true,code:uid(5)},
      {id:uid(7),name:'Organic Chemistry Notes',subject:'Chemistry',description:'Share practice problems and notes',members:[],public:true,code:uid(5)},
      {id:uid(7),name:'History Discussion',subject:'History',description:'Discuss topics and share resources',members:[],public:true,code:uid(5)}
    ];
    for(const g of sample) await put('groups', g);
    // Only refresh lists if the UI is ready; refreshGroupsList handles absence of user safely
    await refreshGroupsList();
  }

  </script>   -->
  <script src="script.js"></script>
</body>
</html>
